<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covid in California</title>

    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        /* Navbar custom styles */
        .navbar {
            background-color: black;
        }

        .navbar-dark .navbar-nav .nav-link {
            color: darkgray;
        }

        .navbar-dark .navbar-nav .active > .nav-link,
        .navbar-dark .navbar-nav .nav-link.active,
        .navbar-dark .navbar-nav .nav-link.show,
        .navbar-dark .navbar-nav .show > .nav-link {
            color: white; /* Active text color */
        }

        .navbar-dark .navbar-nav .nav-link:hover {
            color: yellow; /* Highlight on hover */
        }

        body {
            background-image: url('Covid_Webpage/facemasks_covid.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .navbar {
            position: relative;
            z-index: 1000;
        }

        /* Centered header text for view modules */
        .view-header {
            font-size: 4em;
            text-align: center;
            margin-top: 30vh; /* Vertically center */
        }
    </style>

    <!-- Chroma.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="#" data-view="overview">Overview</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-view="cases-vaccinations">Cases & Vaccinations</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-view="health">Health</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-view="migration">Migration</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Overview View -->
    <div id="overview-view" style="display: none; width: 100%; height: 100%;">
        <h1 class="view-header">This is Overview</h1>
    </div>

    <!-- Cases & Vaccinations View -->
    <div id="cases-vaccinations-view" style="display: none; width: 100%; height: 100%;">
        <h1 class="view-header">This is Cases & Vaccinations</h1>
    </div>

    <!-- Health View -->
    <div id="health-view" style="display: none; width: 100%; height: 100%;">
        <h1 class="view-header">This is Health</h1>
    </div>









    <!-- Migration View Container -->
    <div class="view-module migration-style" data-view-name="migration" style="display: none; height: 100vh; visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center;">

        <!-- Header for Migration View -->
        <div class="migration-header" style="text-align: center; font-size: 60px; position: absolute; top: 20px;">
            US County-to-County Migrations
        </div>

        <!-- Container to hold the map -->
        <div id="mapContainer" style="width: 100vmin; height: 66vmin; position: relative; border: 8px solid rgba(0, 0, 0, 0.5); border-radius: 15px; overflow: hidden;">
            <div id="map" style="width: 100%; height: 100%; position: absolute;"></div>
        </div>

        <!-- Textbox for Top 10 Outflow Counties -->
        <div id="outflowCountiesBox" style="position: absolute; top: 14%; right: 2%; background-color: rgba(255, 255, 255, 0.9); border: 5px solid rgba(0, 0, 0, 0.7); padding: 10px; width: 17%; border-radius: 8px; visibility: hidden;">
            <h5 style="text-align: center;">Greatest Out-Migration</h5>
            <ul id="outflowCountiesList">
                <!-- The list items will be populated using JavaScript -->
            </ul>
        </div>

        <!-- Textbox for Top 10 Inflow Counties -->
        <div id="inflowCountiesBox" style="position: absolute; top: 50%; right: 2%; background-color: rgba(255, 255, 255, 0.9); border: 5px solid rgba(0, 0, 0, 0.7); padding: 10px; width: 17%; border-radius: 8px; visibility: hidden;">
            <h5 style="text-align: center;">Greatest In-Migration</h5>
            <ul id="inflowCountiesList">
                <!-- The list items will be populated using JavaScript -->
            </ul>
        </div>



        <!-- Year Slider -->
        <input type="range" min="2017" max="2021" value="2020" id="yearSlider" style="width: 50%; margin-top: 20px; ">
        <label for="yearSlider" id="yearLabel">Year: 2020</label>


            <!-- Textbox for Highest Out-Migration -->
            <div id="outMigrationBox" style="position: absolute; top: 10%; right: 5%; background-color: rgba(255, 255, 255, 0.9); border: 1px solid rgba(0, 0, 0, 0.5); padding: 15px; width: 20%; border-radius: 8px; visibility: hidden;">
                <h3 style="text-align: center;">Highest Out-Migration</h3>
                <ul id="outMigrationList">
                    <!-- The list items will be dynamically populated using JavaScript -->
                </ul>
            </div>

        
        <style>
            .migration-style {
                position: relative;
                z-index: 10;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 90vh;
            .net-positive {
                color: green;
            }
            .net-negative {
                color: red;
            }
            }   
        </style>


        <script>
            var map = L.map('map').setView([37.8, -96], 4);
            var baseLayer;  
            var dataByYear = {};  // To store GeoJSON data by year

            function fetchDataForYear(year) {
                return fetch(`http://127.0.0.1:5000/api/v1.0/migration_data/${year}`)
                    .then(response => response.json());
            }

            // Fetch data for year 2020 first
            fetchDataForYear(2020).then(data2020 => {
                dataByYear = { 2020: data2020 };
                initializeMigrationMap();  // Initialize the map with 2020 data
                // Fetch data for other years
                return Promise.all([
                    fetchDataForYear(2017),
                    fetchDataForYear(2018),
                    fetchDataForYear(2019),
                    fetchDataForYear(2021)
                ]);
            }).then(([data2017, data2018, data2019, data2021]) => {
                // Store other years data
                dataByYear[2017] = data2017;
                dataByYear[2018] = data2018;
                dataByYear[2019] = data2019;
                dataByYear[2021] = data2021;
                
                // Now that all data is fetched, lazy load the content for the textboxes
                updateOutflowCountiesList();
                updateInflowCountiesList();

            });


            function updateMapData() {
                map.eachLayer(function(layer) {
                    if (layer !== baseLayer) {
                        map.removeLayer(layer);
                    }
                });

                L.geoJson(dataByYear[map_year], {
                    style: function(feature) {
                        var value = feature.properties.net_migration;
                        return {
                            fillColor: getColorForValue(value),
                            weight: .01,
                            fillOpacity: .6
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            var netMigrationFormatted = new Intl.NumberFormat().format(feature.properties.net_migration);
                            var colorClass = feature.properties.net_migration >= 0 ? 'net-positive' : 'net-negative';
                            var tooltipContent = `<strong>${feature.properties.county}, ${feature.properties.state}</strong><br>
                                        Net Migration: <span class="${colorClass}">${netMigrationFormatted}</span>`;
                            layer.bindTooltip(tooltipContent);
                        }
                    }
                }).addTo(map);
            }

            function initializeMigrationMap() {
                var colorScale = chroma.scale('viridis').domain([-121000, 41000]);

                baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                updateMapData(); // Load data for the initial year



                map.invalidateSize();

                updateOutflowCountiesList();  // Initialize the outflow counties list

            }

            var map_year = 2020;  // Default map year

            function updateMapYear() {
                map_year = parseInt(document.getElementById('yearSlider').value);
                document.getElementById('yearLabel').textContent = "Year: " + map_year;
                updateMapData();
                updateOutflowCountiesList(); 
                updateInflowCountiesList();
            }


            document.getElementById('yearSlider').addEventListener('input', updateMapYear);

            document.querySelector('[data-view="migration"]').addEventListener('click', function(event) {
                // event.preventDefault(); // Prevent default link action
                // event.stopPropagation(); // Prevent event from bubbling up
            if (!window.migrationMapInitialized) {
                initializeMigrationMap();
                window.migrationMapInitialized = true;
                    
            // Show the header, map, year slider, year label, and the outflow counties box
            document.querySelector('.migration-header').style.visibility = "visible";
            document.getElementById("mapContainer").style.visibility = "visible";
            document.getElementById("yearSlider").style.visibility = "visible";
            document.getElementById("yearLabel").style.visibility = "visible";
            document.getElementById("migration-header").style.visibility = "visible";
            document.getElementById("outflowCountiesBox").style.visibility = "visible";
            document.getElementById("inflowCountiesBox").style.visibility = "visible";
            }
            });

            bins = [-122000, -10000, -5000, -3000, -2000, -1500, -1000, -500, -100, 0, 1000, 2000, 141000];
            const colors = bins.map((_, i) => chroma.scale('viridis')(i / (bins.length - 1)).hex());


            function getColorForValue(value) {
                for (let i = 0; i < bins.length - 1; i++) {
                    if (value >= bins[i] && value < bins[i + 1]) {
                        return colors[i];
                    }
                }
                return colors[colors.length - 1];
            }


            function updateOutflowCountiesList() {
            // Extract data for the given year
            let yearData = dataByYear[map_year]['features'];
            
            // Calculate percentage of outflow for each county
            yearData.forEach(item => {
                let properties = item.properties;
                properties.pct_out = (properties.outflow / (properties.stayput + properties.outflow)) * 100;
            });

            // Sort by pct_out in descending order
            yearData.sort((a, b) => b.properties.pct_out - a.properties.pct_out);
            
            // Extract top 10
            let top10Counties = yearData.slice(0, 10);

            // Build the list content
            let content = top10Counties.map(item => {
                let props = item.properties;
                let netMigrationFormatted = new Intl.NumberFormat().format(props.net_migration);
                return `<li>${props.county}, ${props.state} ${netMigrationFormatted} ${props.pct_out.toFixed(1)}%</li>`;
            }).join('');

            // Update the content of outflowCountiesList
            document.getElementById('outflowCountiesList').innerHTML = content;
        }


        function updateInflowCountiesList() {
            // Extract data for the given year
            let yearData = dataByYear[map_year]['features'];

            // Calculate percentage of inflow for each county
            yearData.forEach(item => {
                let properties = item.properties;
                properties.pct_in = (properties.inflow / (properties.stayput + properties.inflow)) * 100;
            });

            // Sort by pct_in in descending order
            yearData.sort((a, b) => b.properties.pct_in - a.properties.pct_in);

            // Extract top 10
            let top10Counties = yearData.slice(0, 10);

            // Build the list content
            let content = top10Counties.map(item => {
                let props = item.properties;
                let netMigrationFormatted = new Intl.NumberFormat().format(props.net_migration);
                return `<li>${props.county}, ${props.state} ${netMigrationFormatted} ${props.pct_in.toFixed(1)}%</li>`;
            }).join('');

            // Update the content ofinflowCountiesList
            document.getElementById('inflowCountiesList').innerHTML = content;
        }


        </script>

    </div>



    <script>
        document.querySelectorAll('.nav-link').forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault();

                // Hide all view containers
                document.querySelectorAll('[id$="-view"]').forEach(view => view.style.display = 'none');

                // Get the data-view attribute of the clicked link
                const viewName = event.target.getAttribute('data-view');
                
                // Show the corresponding view container
                document.querySelector(`#${viewName}-view`).style.display = 'block';

                // Update the navbar item styling
                document.querySelectorAll('.nav-link').forEach(link => link.parentElement.classList.remove('active'));
                item.parentElement.classList.add('active');
                
            });
        });
    </script>



</body>

</html>